<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="https://nominatim.org/admin/Migration/">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Migration from older Versions - Nominatim 3.7.0</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../../extra.css" rel="stylesheet" />
  <link href="../../styles.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Migration from older Versions";
    var mkdocs_page_input_path = "admin/Migration.md";
    var mkdocs_page_url = "/admin/Migration/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Nominatim 3.7.0</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">API Reference</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/Overview/">Overview</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/Search/">Search</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/Reverse/">Reverse</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/Lookup/">Address Lookup</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/Details/">Details</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/Status/">Status</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/Output/">Place Output Formats</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/Faq/">FAQ</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Administration Guide</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../Installation/">Basic Installation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Import/">Import</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Update/">Update</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Deployment/">Deploy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Setup-Nominatim-UI/">Nominatim UI</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Advanced-Installations/">Advanced Installations</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Migration from older Versions</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#360-370">3.6.0 -&gt; 3.7.0</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#new-format-and-name-of-configuration-file">New format and name of configuration file</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#new-location-for-data-files">New location for data files</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#introducing-nominatim-command-line-tool">Introducing nominatim command line tool</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#switch-to-normalized-house-numbers">Switch to normalized house numbers</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#350-360">3.5.0 -&gt; 3.6.0</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#change-of-layout-of-search_name_-tables">Change of layout of search_name_* tables</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#removal-of-html-output">Removal of html output</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#change-order-during-indexing">Change order during indexing</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#unused-index">Unused index</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#switching-to-dotenv">Switching to dotenv</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#340-350">3.4.0 -&gt; 3.5.0</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#new-wikipediawikidata-importance-tables">New Wikipedia/Wikidata importance tables</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#330-340">3.3.0 -&gt; 3.4.0</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#reorganisation-of-location_area_country-table">Reorganisation of location_area_country table</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#320-330">3.2.0 -&gt; 3.3.0</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#new-database-connection-string-dsn-format">New database connection string (DSN) format</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#natural-earth-country-boundaries-no-longer-needed-as-fallback">Natural Earth country boundaries no longer needed as fallback</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configurable-address-levels">Configurable Address Levels</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#310-320">3.1.0 -&gt; 3.2.0</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#new-reverse-algorithm">New reverse algorithm</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#300-310">3.0.0 -&gt; 3.1.0</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#postcode-table">Postcode Table</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Faq/">Troubleshooting</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Developers Guide</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../develop/Development-Environment/">Setup for Development</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../develop/overview/">Architecture Overview</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../develop/Import/">OSM Data Import</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../develop/Ranking/">Place Ranking</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../develop/Postcodes/">Postcodes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../develop/Testing/">Testing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../develop/data-sources/">External Data Sources</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Appendix</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../appendix/Install-on-Centos-7/">Installation on CentOS 7</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../appendix/Install-on-Centos-8/">Installation on CentOS 8</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../appendix/Install-on-Ubuntu-18/">Installation on Ubuntu 18</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../appendix/Install-on-Ubuntu-20/">Installation on Ubuntu 20</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Nominatim 3.7.0</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Administration Guide &raquo;</li>
        
      
    
    <li>Migration from older Versions</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/openstreetmap/Nominatim/edit/master/docs/admin/Migration.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="database-migrations">Database Migrations<a class="headerlink" href="#database-migrations" title="Permanent link"></a></h1>
<p>Since version 3.7.0 Nominatim offers automatic migrations. Please follow
the following steps:</p>
<ul>
<li>stop any updates that are potentially running</li>
<li>update Nominatim to the newer version</li>
<li>go to your project directory and run <code>nominatim admin --migrate</code></li>
<li>(optionally) restart updates</li>
</ul>
<p>Below you find additional migrations and hints about other structural and
breaking changes. <strong>Please read them before running the migration.</strong></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are migrating from a version &lt;3.6, then you still have to follow
the manual migration steps up to 3.6.</p>
</div>
<h2 id="360-370">3.6.0 -&gt; 3.7.0<a class="headerlink" href="#360-370" title="Permanent link"></a></h2>
<h3 id="new-format-and-name-of-configuration-file">New format and name of configuration file<a class="headerlink" href="#new-format-and-name-of-configuration-file" title="Permanent link"></a></h3>
<p>The configuration for an import is now saved in a <code>.env</code> file in the project
directory. This file follows the dotenv format. For more information, see
the <a href="../Import/#configuration-setup-in-env">installation chapter</a>.</p>
<p>To migrate to the new system, create a new project directory, add the <code>.env</code>
file and port your custom configuration from <code>settings/local.php</code>. Most
settings are named similar and only have received a <code>NOMINATIM_</code> prefix.
Use the default settings in <code>settings/env.defaults</code> as a reference.</p>
<h3 id="new-location-for-data-files">New location for data files<a class="headerlink" href="#new-location-for-data-files" title="Permanent link"></a></h3>
<p>External data files for Wikipedia importance, postcodes etc. are no longer
expected to reside in the source tree by default. Instead they will be searched
in the project directory. If you have an automated setup script you must
either adapt the download location or explicitly set the location of the
files to the old place in your <code>.env</code>.</p>
<h3 id="introducing-nominatim-command-line-tool">Introducing <code>nominatim</code> command line tool<a class="headerlink" href="#introducing-nominatim-command-line-tool" title="Permanent link"></a></h3>
<p>The various php utilities have been replaced with a single <code>nominatim</code>
command line tool. Make sure to adapt any scripts. There is no direct 1:1
matching between the old utilities and the commands of nominatim CLI. The
following list gives you a list of nominatim sub-commands that contain
functionality of each script:</p>
<ul>
<li>./utils/setup.php: <code>import</code>, <code>freeze</code>, <code>refresh</code></li>
<li>./utils/update.php: <code>replication</code>, <code>add-data</code>, <code>index</code>, <code>refresh</code></li>
<li>./utils/specialphrases.php: <code>special-phrases</code></li>
<li>./utils/check_import_finished.php: <code>admin</code></li>
<li>./utils/warm.php: <code>admin</code></li>
<li>./utils/export.php: <code>export</code></li>
</ul>
<p>Try <code>nominatim &lt;command&gt; --help</code> for more information about each subcommand.</p>
<p><code>./utils/query.php</code> no longer exists in its old form. <code>nominatim search</code>
provides a replacement but returns different output.</p>
<h3 id="switch-to-normalized-house-numbers">Switch to normalized house numbers<a class="headerlink" href="#switch-to-normalized-house-numbers" title="Permanent link"></a></h3>
<p>The housenumber column in the placex table uses now normalized version.
The automatic migration step will convert the column but this may take a
very long time. It is advisable to take the machine offline while doing that.</p>
<h2 id="350-360">3.5.0 -&gt; 3.6.0<a class="headerlink" href="#350-360" title="Permanent link"></a></h2>
<h3 id="change-of-layout-of-search_name_-tables">Change of layout of search_name_* tables<a class="headerlink" href="#change-of-layout-of-search_name_-tables" title="Permanent link"></a></h3>
<p>The table need a different index for nearest place lookup. Recreate the
indexes using the following shell script:</p>
<div class="codehilite"><pre><span></span><code><span class="k">for</span> table in <span class="sb">`</span>psql -d nominatim -c <span class="s2">&quot;SELECT tablename FROM pg_tables WHERE tablename LIKE &#39;search_name_%&#39;&quot;</span> -tA <span class="p">|</span> grep -v search_name_blank<span class="sb">`</span><span class="p">;</span>
<span class="k">do</span>
    psql -d nominatim -c <span class="s2">&quot;DROP INDEX idx_</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">_centroid_place; CREATE INDEX idx_</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">_centroid_place ON </span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2"> USING gist (centroid) WHERE ((address_rank &gt;= 2) AND (address_rank &lt;= 25)); DROP INDEX idx_</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">_centroid_street; CREATE INDEX idx_</span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2">_centroid_street ON </span><span class="si">${</span><span class="nv">table</span><span class="si">}</span><span class="s2"> USING gist (centroid) WHERE ((address_rank &gt;= 26) AND (address_rank &lt;= 27))&quot;</span><span class="p">;</span>
<span class="k">done</span>
</code></pre></div>


<h3 id="removal-of-html-output">Removal of html output<a class="headerlink" href="#removal-of-html-output" title="Permanent link"></a></h3>
<p>The debugging UI is no longer directly provided with Nominatim. Instead we
now provide a simple Javascript application. Please refer to
<a href="../Setup-Nominatim-UI">Setting up the Nominatim UI</a> for details on how to
set up the UI.</p>
<p>The icons served together with the API responses have been moved to the
nominatim-ui project as well. If you want to keep the <code>icon</code> field in the
response, you need to set <code>CONST_MapIcon_URL</code> to the URL of the <code>/mapicon</code>
directory of nominatim-ui.</p>
<h3 id="change-order-during-indexing">Change order during indexing<a class="headerlink" href="#change-order-during-indexing" title="Permanent link"></a></h3>
<p>When reindexing places during updates, there is now a different order used
which needs a different database index. Create it with the following SQL command:</p>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_placex_pendingsector_rank_address</span>
  <span class="k">ON</span> <span class="n">placex</span>
  <span class="k">USING</span> <span class="n">BTREE</span> <span class="p">(</span><span class="n">rank_address</span><span class="p">,</span> <span class="n">geometry_sector</span><span class="p">)</span>
  <span class="k">WHERE</span> <span class="n">indexed_status</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div>


<p>You can then drop the old index with:</p>
<div class="codehilite"><pre><span></span><code><span class="k">DROP</span> <span class="k">INDEX</span> <span class="n">idx_placex_pendingsector</span><span class="p">;</span>
</code></pre></div>


<h3 id="unused-index">Unused index<a class="headerlink" href="#unused-index" title="Permanent link"></a></h3>
<p>This index has been unused ever since the query using it was changed two years ago. Saves about 12GB on a planet installation.</p>
<div class="codehilite"><pre><span></span><code><span class="k">DROP</span> <span class="k">INDEX</span> <span class="n">idx_placex_geometry_reverse_lookupPoint</span><span class="p">;</span>
</code></pre></div>


<h3 id="switching-to-dotenv">Switching to dotenv<a class="headerlink" href="#switching-to-dotenv" title="Permanent link"></a></h3>
<p>As part of the work changing the configuration format, the configuration for
the website is now using a separate configuration file. To create the
configuration file, run the following command after updating:</p>
<div class="codehilite"><pre><span></span><code>./utils/setup.php --setup-website
</code></pre></div>


<h2 id="340-350">3.4.0 -&gt; 3.5.0<a class="headerlink" href="#340-350" title="Permanent link"></a></h2>
<h3 id="new-wikipediawikidata-importance-tables">New Wikipedia/Wikidata importance tables<a class="headerlink" href="#new-wikipediawikidata-importance-tables" title="Permanent link"></a></h3>
<p>The <code>wikipedia_*</code> tables have a new format that also includes references to
Wikidata. You need to update the computation functions and the tables as
follows:</p>
<ul>
<li>download the new Wikipedia tables as described in the import section</li>
<li>reimport the tables: <code>./utils/setup.php --import-wikipedia-articles</code></li>
<li>update the functions: <code>./utils/setup.php --create-functions --enable-diff-updates</code></li>
<li>create a new lookup index:</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_placex_wikidata</span>
  <span class="k">ON</span> <span class="n">placex</span>
  <span class="k">USING</span> <span class="n">BTREE</span> <span class="p">((</span><span class="n">extratags</span> <span class="o">-&gt;</span> <span class="s1">&#39;wikidata&#39;</span><span class="p">))</span>
  <span class="k">WHERE</span> <span class="n">extratags</span> <span class="o">?</span> <span class="s1">&#39;wikidata&#39;</span>
    <span class="k">AND</span> <span class="k">class</span> <span class="o">=</span> <span class="s1">&#39;place&#39;</span>
    <span class="k">AND</span> <span class="n">osm_type</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span>
    <span class="k">AND</span> <span class="n">rank_search</span> <span class="o">&lt;</span> <span class="mi">26</span><span class="p">;</span>
</code></pre></div>


<ul>
<li>compute importance: <code>./utils/update.php --recompute-importance</code></li>
</ul>
<p>The last step takes about 10 hours on the full planet.</p>
<p>Remove one function (it will be recreated in the next step):</p>
<div class="codehilite"><pre><span></span><code><span class="k">DROP</span> <span class="k">FUNCTION</span> <span class="n">create_country</span><span class="p">(</span><span class="n">hstore</span><span class="p">,</span><span class="nb">character</span> <span class="nb">varying</span><span class="p">);</span>
</code></pre></div>


<p>Finally, update all SQL functions:</p>
<div class="codehilite"><pre><span></span><code>./utils/setup.php --create-functions --enable-diff-updates --create-partition-functions
</code></pre></div>


<h2 id="330-340">3.3.0 -&gt; 3.4.0<a class="headerlink" href="#330-340" title="Permanent link"></a></h2>
<h3 id="reorganisation-of-location_area_country-table">Reorganisation of location_area_country table<a class="headerlink" href="#reorganisation-of-location_area_country-table" title="Permanent link"></a></h3>
<p>The table <code>location_area_country</code> has been optimized. You need to switch to the
new format when you run updates. While updates are disabled, run the following
SQL commands:</p>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">location_area_country_new</span> <span class="k">AS</span>
  <span class="k">SELECT</span> <span class="n">place_id</span><span class="p">,</span> <span class="n">country_code</span><span class="p">,</span> <span class="n">geometry</span> <span class="k">FROM</span> <span class="n">location_area_country</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">location_area_country</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">location_area_country_new</span> <span class="k">RENAME</span> <span class="k">TO</span> <span class="n">location_area_country</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_location_area_country_geometry</span> <span class="k">ON</span> <span class="n">location_area_country</span> <span class="k">USING</span> <span class="n">GIST</span> <span class="p">(</span><span class="n">geometry</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_location_area_country_place_id</span> <span class="k">ON</span> <span class="n">location_area_country</span> <span class="k">USING</span> <span class="n">BTREE</span> <span class="p">(</span><span class="n">place_id</span><span class="p">);</span>
</code></pre></div>


<p>Finally, update all SQL functions:</p>
<div class="codehilite"><pre><span></span><code>./utils/setup.php --create-functions --enable-diff-updates --create-partition-functions
</code></pre></div>


<h2 id="320-330">3.2.0 -&gt; 3.3.0<a class="headerlink" href="#320-330" title="Permanent link"></a></h2>
<h3 id="new-database-connection-string-dsn-format">New database connection string (DSN) format<a class="headerlink" href="#new-database-connection-string-dsn-format" title="Permanent link"></a></h3>
<p>Previously database connection setting (<code>CONST_Database_DSN</code> in <code>settings/*.php</code>) had the format</p>
<ul>
<li>(simple) <code>pgsql://@/nominatim</code></li>
<li>(complex) <code>pgsql://johndoe:secret@machine1.domain.com:1234/db1</code></li>
</ul>
<p>The new format is</p>
<ul>
<li>(simple) <code>pgsql:dbname=nominatim</code></li>
<li>(complex) <code>pgsql:dbname=db1;host=machine1.domain.com;port=1234;user=johndoe;password=secret</code></li>
</ul>
<h3 id="natural-earth-country-boundaries-no-longer-needed-as-fallback">Natural Earth country boundaries no longer needed as fallback<a class="headerlink" href="#natural-earth-country-boundaries-no-longer-needed-as-fallback" title="Permanent link"></a></h3>
<div class="codehilite"><pre><span></span><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">country_naturalearthdata</span><span class="p">;</span>
</code></pre></div>


<p>Finally, update all SQL functions:</p>
<div class="codehilite"><pre><span></span><code>./utils/setup.php --create-functions --enable-diff-updates --create-partition-functions
</code></pre></div>


<h3 id="configurable-address-levels">Configurable Address Levels<a class="headerlink" href="#configurable-address-levels" title="Permanent link"></a></h3>
<p>The new configurable address levels require a new table. Create it with the
following command:</p>
<div class="codehilite"><pre><span></span><code>./utils/update.php --update-address-levels
</code></pre></div>


<h2 id="310-320">3.1.0 -&gt; 3.2.0<a class="headerlink" href="#310-320" title="Permanent link"></a></h2>
<h3 id="new-reverse-algorithm">New reverse algorithm<a class="headerlink" href="#new-reverse-algorithm" title="Permanent link"></a></h3>
<p>The reverse algorithm has changed and requires new indexes. Run the following
SQL statements to create the indexes:</p>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_placex_geometry_reverse_lookupPoint</span>
  <span class="k">ON</span> <span class="n">placex</span>
  <span class="k">USING</span> <span class="n">gist</span> <span class="p">(</span><span class="n">geometry</span><span class="p">)</span>
  <span class="k">WHERE</span> <span class="p">(</span><span class="n">name</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">null</span> <span class="k">or</span> <span class="n">housenumber</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">null</span> <span class="k">or</span> <span class="n">rank_address</span> <span class="k">BETWEEN</span> <span class="mi">26</span> <span class="k">AND</span> <span class="mi">27</span><span class="p">)</span>
    <span class="k">AND</span> <span class="k">class</span> <span class="k">NOT</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;railway&#39;</span><span class="p">,</span><span class="s1">&#39;tunnel&#39;</span><span class="p">,</span><span class="s1">&#39;bridge&#39;</span><span class="p">,</span><span class="s1">&#39;man_made&#39;</span><span class="p">)</span>
    <span class="k">AND</span> <span class="n">rank_address</span> <span class="o">&gt;=</span> <span class="mi">26</span>
    <span class="k">AND</span> <span class="n">indexed_status</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">AND</span> <span class="n">linked_place_id</span> <span class="k">IS</span> <span class="k">null</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_placex_geometry_reverse_lookupPolygon</span>
  <span class="k">ON</span> <span class="n">placex</span> <span class="k">USING</span> <span class="n">gist</span> <span class="p">(</span><span class="n">geometry</span><span class="p">)</span>
  <span class="k">WHERE</span> <span class="n">St_GeometryType</span><span class="p">(</span><span class="n">geometry</span><span class="p">)</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;ST_Polygon&#39;</span><span class="p">,</span> <span class="s1">&#39;ST_MultiPolygon&#39;</span><span class="p">)</span>
    <span class="k">AND</span> <span class="n">rank_address</span> <span class="k">between</span> <span class="mi">4</span> <span class="k">and</span> <span class="mi">25</span>
    <span class="k">AND</span> <span class="k">type</span> <span class="o">!=</span> <span class="s1">&#39;postcode&#39;</span>
    <span class="k">AND</span> <span class="n">name</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
    <span class="k">AND</span> <span class="n">indexed_status</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">AND</span> <span class="n">linked_place_id</span> <span class="k">is</span> <span class="k">null</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_placex_geometry_reverse_placeNode</span>
  <span class="k">ON</span> <span class="n">placex</span> <span class="k">USING</span> <span class="n">gist</span> <span class="p">(</span><span class="n">geometry</span><span class="p">)</span>
  <span class="k">WHERE</span> <span class="n">osm_type</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span>
    <span class="k">AND</span> <span class="n">rank_search</span> <span class="k">between</span> <span class="mi">5</span> <span class="k">and</span> <span class="mi">25</span>
    <span class="k">AND</span> <span class="k">class</span> <span class="o">=</span> <span class="s1">&#39;place&#39;</span>
    <span class="k">AND</span> <span class="k">type</span> <span class="o">!=</span> <span class="s1">&#39;postcode&#39;</span>
    <span class="k">AND</span> <span class="n">name</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
    <span class="k">AND</span> <span class="n">indexed_status</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">AND</span> <span class="n">linked_place_id</span> <span class="k">is</span> <span class="k">null</span><span class="p">;</span>
</code></pre></div>


<p>You also need to grant the website user access to the <code>country_osm_grid</code> table:</p>
<div class="codehilite"><pre><span></span><code><span class="k">GRANT</span> <span class="k">SELECT</span> <span class="k">ON</span> <span class="k">table</span> <span class="n">country_osm_grid</span> <span class="k">to</span> <span class="ss">&quot;www-user&quot;</span><span class="p">;</span>
</code></pre></div>


<p>Replace the <code>www-user</code> with the user name of your website server if necessary.</p>
<p>You can now drop the unused indexes:</p>
<div class="codehilite"><pre><span></span><code><span class="k">DROP</span> <span class="k">INDEX</span> <span class="n">idx_placex_reverse_geometry</span><span class="p">;</span>
</code></pre></div>


<p>Finally, update all SQL functions:</p>
<div class="codehilite"><pre><span></span><code>./utils/setup.php --create-functions --enable-diff-updates --create-partition-functions
</code></pre></div>


<h2 id="300-310">3.0.0 -&gt; 3.1.0<a class="headerlink" href="#300-310" title="Permanent link"></a></h2>
<h3 id="postcode-table">Postcode Table<a class="headerlink" href="#postcode-table" title="Permanent link"></a></h3>
<p>A new separate table for artificially computed postcode centroids was introduced.
Migration to the new format is possible but <strong>not recommended</strong>.</p>
<p>Create postcode table and indexes, running the following SQL statements:</p>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">location_postcode</span>
  <span class="p">(</span><span class="n">place_id</span> <span class="nb">BIGINT</span><span class="p">,</span> <span class="n">parent_place_id</span> <span class="nb">BIGINT</span><span class="p">,</span> <span class="n">rank_search</span> <span class="nb">SMALLINT</span><span class="p">,</span>
   <span class="n">rank_address</span> <span class="nb">SMALLINT</span><span class="p">,</span> <span class="n">indexed_status</span> <span class="nb">SMALLINT</span><span class="p">,</span> <span class="n">indexed_date</span> <span class="k">TIMESTAMP</span><span class="p">,</span>
   <span class="n">country_code</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">postcode</span> <span class="nb">TEXT</span><span class="p">,</span>
   <span class="n">geometry</span> <span class="n">GEOMETRY</span><span class="p">(</span><span class="n">Geometry</span><span class="p">,</span> <span class="mi">4326</span><span class="p">));</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_postcode_geometry</span> <span class="k">ON</span> <span class="n">location_postcode</span> <span class="k">USING</span> <span class="n">GIST</span> <span class="p">(</span><span class="n">geometry</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">UNIQUE</span> <span class="k">INDEX</span> <span class="n">idx_postcode_id</span> <span class="k">ON</span> <span class="n">location_postcode</span> <span class="k">USING</span> <span class="n">BTREE</span> <span class="p">(</span><span class="n">place_id</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">idx_postcode_postcode</span> <span class="k">ON</span> <span class="n">location_postcode</span> <span class="k">USING</span> <span class="n">BTREE</span> <span class="p">(</span><span class="n">postcode</span><span class="p">);</span>
<span class="k">GRANT</span> <span class="k">SELECT</span> <span class="k">ON</span> <span class="n">location_postcode</span> <span class="k">TO</span> <span class="ss">&quot;www-data&quot;</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TYPE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">nearfeaturecentr</span> <span class="k">CASCADE</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TYPE</span> <span class="n">nearfeaturecentr</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="n">place_id</span> <span class="nb">BIGINT</span><span class="p">,</span>
  <span class="n">keywords</span> <span class="nb">int</span><span class="p">[],</span>
  <span class="n">rank_address</span> <span class="nb">smallint</span><span class="p">,</span>
  <span class="n">rank_search</span> <span class="nb">smallint</span><span class="p">,</span>
  <span class="n">distance</span> <span class="nb">float</span><span class="p">,</span>
  <span class="n">isguess</span> <span class="nb">boolean</span><span class="p">,</span>
  <span class="n">postcode</span> <span class="nb">TEXT</span><span class="p">,</span>
  <span class="n">centroid</span> <span class="n">GEOMETRY</span>
<span class="p">);</span>
</code></pre></div>


<p>Add postcode column to <code>location_area</code> tables with SQL statement:</p>
<div class="codehilite"><pre><span></span><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">location_area</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">postcode</span> <span class="nb">TEXT</span><span class="p">;</span>
</code></pre></div>


<p>Then reimport the functions:</p>
<div class="codehilite"><pre><span></span><code>./utils/setup.php --create-functions --enable-diff-updates --create-partition-functions
</code></pre></div>


<p>Create appropriate triggers with SQL:</p>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">location_postcode_before_update</span> <span class="k">BEFORE</span> <span class="k">UPDATE</span> <span class="k">ON</span> <span class="n">location_postcode</span>
    <span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span> <span class="k">EXECUTE</span> <span class="k">PROCEDURE</span> <span class="n">postcode_update</span><span class="p">();</span>
</code></pre></div>


<p>Finally populate the postcode table (will take a while):</p>
<div class="codehilite"><pre><span></span><code>./utils/setup.php --calculate-postcodes --index --index-noanalyse
</code></pre></div>


<p>This will create a working database. You may also delete the old artificial
postcodes now. Note that this may be expensive and is not absolutely necessary.
The following SQL statement will remove them:</p>
<div class="codehilite"><pre><span></span><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">place_addressline</span> <span class="n">a</span> <span class="k">USING</span> <span class="n">placex</span> <span class="n">p</span>
 <span class="k">WHERE</span> <span class="n">a</span><span class="p">.</span><span class="n">address_place_id</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">place_id</span> <span class="k">and</span> <span class="n">p</span><span class="p">.</span><span class="n">osm_type</span> <span class="o">=</span> <span class="s1">&#39;P&#39;</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">placex</span> <span class="n">DISABLE</span> <span class="k">TRIGGER</span> <span class="k">USER</span><span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">placex</span> <span class="k">WHERE</span> <span class="n">osm_type</span> <span class="o">=</span> <span class="s1">&#39;P&#39;</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">placex</span> <span class="n">ENABLE</span> <span class="k">TRIGGER</span> <span class="k">USER</span><span class="p">;</span>
</code></pre></div>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Faq/" class="btn btn-neutral float-right" title="Troubleshooting">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../Advanced-Installations/" class="btn btn-neutral" title="Advanced Installations"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/openstreetmap/Nominatim/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../Advanced-Installations/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../Faq/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://nominatim.org/admin/Advanced-Installations/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Advanced Installations - Nominatim 4.2.3</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../../extra.css" rel="stylesheet" />
        <link href="../../styles.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Advanced Installations";
        var mkdocs_page_input_path = "admin/Advanced-Installations.md";
        var mkdocs_page_url = "/admin/Advanced-Installations/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Nominatim 4.2.3
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Search/">Search</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Reverse/">Reverse</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Lookup/">Address Lookup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Details/">Details</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Status/">Status</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Output/">Place Output Formats</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Faq/">FAQ</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Administration Guide</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../Installation/">Basic Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Import/">Import</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Update/">Update</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Deployment/">Deploy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Setup-Nominatim-UI/">Nominatim UI</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Advanced Installations</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#importing-multiple-regions-without-updates">Importing multiple regions (without updates)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#importing-multiple-regions-with-updates">Importing multiple regions (with updates)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#setting-up-multiple-regions">Setting up multiple regions</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#updating-the-database">Updating the database</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#using-an-external-postgresql-database">Using an external PostgreSQL database</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#option-1-compiling-the-library-on-the-database-server">Option 1: Compiling the library on the database server</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#option-2-compiling-the-library-on-the-import-machine">Option 2: Compiling the library on the import machine</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#running-the-import">Running the import</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#moving-the-database-to-another-machine">Moving the database to another machine</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Maintenance/">Maintenance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Migration/">Migration from older Versions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Faq/">Troubleshooting</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Customization Guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Import-Styles/">Import Styles</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Settings/">Configuration Settings</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Country-Settings/">Per-Country Data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Ranking/">Place Ranking</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Importance/">Importance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Tokenizers/">Tokenizers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Special-Phrases/">Special Phrases</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Tiger/">External data: US housenumbers from TIGER</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Postcodes/">External data: Postcodes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Developers Guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../develop/overview/">Architecture Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../develop/Database-Layout/">Database Layout</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../develop/Indexing/">Indexing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../develop/Tokenizers/">Tokenizers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../develop/ICU-Tokenizer-Modules/">Custom modules for ICU tokenizer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../develop/Development-Environment/">Setup for Development</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../develop/Testing/">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../develop/data-sources/">External Data Sources</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/Install-on-Ubuntu-18/">Installation on Ubuntu 18</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/Install-on-Ubuntu-20/">Installation on Ubuntu 20</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/Install-on-Ubuntu-22/">Installation on Ubuntu 22</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Nominatim 4.2.3</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Administration Guide &raquo;</li>
      <li>Advanced Installations</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/openstreetmap/Nominatim/edit/master/docs/admin/Advanced-Installations.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="advanced-installations">Advanced installations<a class="headerlink" href="#advanced-installations" title="Permanent link"></a></h1>
<p>This page contains instructions for setting up multiple countries in 
your Nominatim database. It is assumed that you have already successfully
installed the Nominatim software itself, if not return to the 
<a href="../Installation/">installation page</a>.</p>
<h2 id="importing-multiple-regions-without-updates">Importing multiple regions (without updates)<a class="headerlink" href="#importing-multiple-regions-without-updates" title="Permanent link"></a></h2>
<p>To import multiple regions in your database you can simply give multiple
OSM files to the import command:</p>
<div class="codehilite"><pre><span></span><code><span class="n">nominatim</span> <span class="kn">import</span> <span class="o">--</span><span class="n">osm</span><span class="o">-</span><span class="n">file</span> <span class="n">file1</span><span class="o">.</span><span class="n">pbf</span> <span class="o">--</span><span class="n">osm</span><span class="o">-</span><span class="n">file</span> <span class="n">file2</span><span class="o">.</span><span class="n">pbf</span>
</code></pre></div>

<p>If you already have imported a file and want to add another one, you can
use the add-data function to import the additional data as follows:</p>
<div class="codehilite"><pre><span></span><code>nominatim add-data --file &lt;FILE&gt;
nominatim refresh --postcodes
nominatim index -j &lt;NUMBER OF THREADS&gt;
</code></pre></div>

<p>Please note that adding additional data is always significantly slower than
the original import.</p>
<h2 id="importing-multiple-regions-with-updates">Importing multiple regions (with updates)<a class="headerlink" href="#importing-multiple-regions-with-updates" title="Permanent link"></a></h2>
<p>If you want to import multiple regions <em>and</em> be able to keep them up-to-date
with updates, then you can use the scripts provided in the <code>utils</code> directory.</p>
<p>These scripts will set up an <code>update</code> directory in your project directory,
which has the following structure:</p>
<div class="codehilite"><pre><span></span><code>update
<span class="w">    </span>├──<span class="w"> </span>europe
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>andorra
<span class="w">    </span>│<span class="w">   </span>│<span class="w">   </span>└──<span class="w"> </span>sequence.state
<span class="w">    </span>│<span class="w">   </span>└──<span class="w"> </span>monaco
<span class="w">    </span>│<span class="w">       </span>└──<span class="w"> </span>sequence.state
<span class="w">    </span>└──<span class="w"> </span>tmp
<span class="w">        </span>└──<span class="w"> </span>europe
<span class="w">                </span>├──<span class="w"> </span>andorra-latest.osm.pbf
<span class="w">                </span>└──<span class="w"> </span>monaco-latest.osm.pbf
</code></pre></div>

<p>The <code>sequence.state</code> files contain the sequence ID for each region. They will
be used by pyosmium to get updates. The <code>tmp</code> folder is used for import dump and
can be deleted once the import is complete.</p>
<h3 id="setting-up-multiple-regions">Setting up multiple regions<a class="headerlink" href="#setting-up-multiple-regions" title="Permanent link"></a></h3>
<p>Create a project directory as described for the
<a href="../Import/#creating-the-project-directory">simple import</a>. If necessary,
you can also add an <code>.env</code> configuration with customized options. In particular,
you need to make sure that <code>NOMINATIM_REPLICATION_UPDATE_INTERVAL</code> and
<code>NOMINATIM_REPLICATION_RECHECK_INTERVAL</code> are set according to the update
interval of the extract server you use.</p>
<p>Copy the scripts <code>utils/import_multiple_regions.sh</code> and <code>utils/update_database.sh</code>
into the project directory.</p>
<p>Now customize both files as per your requirements</p>
<ol>
<li>
<p>List of countries. e.g.</p>
<div class="codehilite"><pre><span></span><code>COUNTRIES=&quot;europe/monaco europe/andorra&quot;
</code></pre></div>

</li>
<li>
<p>URL to the service providing the extracts and updates. eg:</p>
<div class="codehilite"><pre><span></span><code><span class="n">BASEURL</span><span class="o">=</span><span class="s2">&quot;https://download.geofabrik.de&quot;</span>
<span class="n">DOWNCOUNTRYPOSTFIX</span><span class="o">=</span><span class="s2">&quot;-latest.osm.pbf&quot;</span>
</code></pre></div>

</li>
<li>
<p>Followup in the update script can be set according to your installation.
   E.g. for Photon,</p>
<div class="codehilite"><pre><span></span><code>FOLLOWUP=&quot;curl http://localhost:2322/nominatim-update&quot;
</code></pre></div>

<p>will handle the indexing.</p>
</li>
</ol>
<p>To start the initial import, change into the project directory and run</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">bash</span><span class="w"> </span><span class="n">import_multiple_regions</span><span class="p">.</span><span class="n">sh</span>
</code></pre></div>

<h3 id="updating-the-database">Updating the database<a class="headerlink" href="#updating-the-database" title="Permanent link"></a></h3>
<p>Change into the project directory and run the following command:</p>
<div class="codehilite"><pre><span></span><code>bash update_database.sh
</code></pre></div>

<p>This will get diffs from the replication server, import diffs and index
the database. The default replication server in the
script(<a href="https://download.geofabrik.de">Geofabrik</a>) provides daily updates.</p>
<h2 id="using-an-external-postgresql-database">Using an external PostgreSQL database<a class="headerlink" href="#using-an-external-postgresql-database" title="Permanent link"></a></h2>
<p>You can install Nominatim using a database that runs on a different server when
you have physical access to the file system on the other server. Nominatim
uses a custom normalization library that needs to be made accessible to the
PostgreSQL server. This section explains how to set up the normalization
library.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The external module is only needed when using the legacy tokenizer.
If you have chosen the ICU tokenizer, then you can ignore this section
and follow the standard import documentation.</p>
</div>
<h3 id="option-1-compiling-the-library-on-the-database-server">Option 1: Compiling the library on the database server<a class="headerlink" href="#option-1-compiling-the-library-on-the-database-server" title="Permanent link"></a></h3>
<p>The most sure way to get a working library is to compile it on the database
server. From the prerequisites you need at least cmake, gcc and the
PostgreSQL server package.</p>
<p>Clone or unpack the Nominatim source code, enter the source directory and
create and enter a build directory.</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>Nominatim
mkdir<span class="w"> </span>build
<span class="nb">cd</span><span class="w"> </span>build
</code></pre></div>

<p>Now configure cmake to only build the PostgreSQL module and build it:</p>
<div class="codehilite"><pre><span></span><code>cmake -DBUILD_IMPORTER=off -DBUILD_API=off -DBUILD_TESTS=off -DBUILD_DOCS=off -DBUILD_OSM2PGSQL=off ..
make
</code></pre></div>

<p>When done, you find the normalization library in <code>build/module/nominatim.so</code>.
Copy it to a place where it is readable and executable by the PostgreSQL server
process.</p>
<h3 id="option-2-compiling-the-library-on-the-import-machine">Option 2: Compiling the library on the import machine<a class="headerlink" href="#option-2-compiling-the-library-on-the-import-machine" title="Permanent link"></a></h3>
<p>You can also compile the normalization library on the machine from where you
run the import.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>You can only do this when the database server and the import machine have
the same architecture and run the same version of Linux. Otherwise there is
no guarantee that the compiled library is compatible with the PostgreSQL
server running on the database server.</p>
</div>
<p>Make sure that the PostgreSQL server package is installed on the machine
<strong>with the same version as on the database server</strong>. You do not need to install
the PostgreSQL server itself.</p>
<p>Download and compile Nominatim as per standard instructions. Once done, you find
the normalization library in <code>build/module/nominatim.so</code>. Copy the file to
the database server at a location where it is readable and executable by the
PostgreSQL server process.</p>
<h3 id="running-the-import">Running the import<a class="headerlink" href="#running-the-import" title="Permanent link"></a></h3>
<p>On the client side you now need to configure the import to point to the
correct location of the library <strong>on the database server</strong>. Add the following
line to your your <code>.env</code> file:</p>
<div class="codehilite"><pre><span></span><code><span class="x">NOMINATIM_DATABASE_MODULE_PATH=&quot;&lt;directory on the database server where nominatim.so resides&gt;&quot;</span>
</code></pre></div>

<p>Now change the <code>NOMINATIM_DATABASE_DSN</code> to point to your remote server and continue
to follow the <a href="../Import/">standard instructions for importing</a>.</p>
<h2 id="moving-the-database-to-another-machine">Moving the database to another machine<a class="headerlink" href="#moving-the-database-to-another-machine" title="Permanent link"></a></h2>
<p>For some configurations it may be useful to run the import on one machine, then
move the database to another machine and run the Nominatim service from there.
For example, you might want to use a large machine to be able to run the import
quickly but only want a smaller machine for production because there is not so
much load. Or you might want to do the import once and then replicate the
database to many machines.</p>
<p>The important thing to keep in mind when transferring the Nominatim installation
is that you need to transfer the database <em>and the project directory</em>. Both
parts are essential for your installation.</p>
<p>The Nominatim database can be transferred using the <code>pg_dump</code>/<code>pg_restore</code> tool.
Make sure to use the same version of PostgreSQL and PostGIS on source and
target machine.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Before creating a dump of your Nominatim database, consider running
<code>nominatim freeze</code> first. Your database looses the ability to receive further
data updates but the resulting database is only about a third of the size
of a full database.</p>
</div>
<p>Next install Nominatim on the target machine by following the standard installation
instructions. Again, make sure to use the same version as the source machine.</p>
<p>Create a project directory on your destination machine and set up the <code>.env</code>
file to match the configuration on the source machine. Finally run</p>
<div class="codehilite"><pre><span></span><code>nominatim refresh --website
</code></pre></div>

<p>to make sure that the local installation of Nominatim will be used.</p>
<p>If you are using the legacy tokenizer you might also have to switch to the
PostgreSQL module that was compiled on your target machine. If you get errors
that PostgreSQL cannot find or access <code>nominatim.so</code> then rerun</p>
<p>nominatim refresh --functions</p>
<p>on the target machine to update the the location of the module.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../Setup-Nominatim-UI/" class="btn btn-neutral float-left" title="Nominatim UI"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../Maintenance/" class="btn btn-neutral float-right" title="Maintenance">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/openstreetmap/Nominatim" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../Setup-Nominatim-UI/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../Maintenance/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
